<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>CallBack</title>
</head>
<body>
    <script>
        function getHashParams() {

            var hashParams = {};
            var e,
                a = /\+/g,  // Regex for replacing addition symbol with a space
                r = /([^&;=]+)=?([^&;]*)/g,
                d = function (s) { return decodeURIComponent(s.replace(a, " ")); },
                q = window.location.hash.substring(1);

            while (e = r.exec(q))
            hashParams[d(e[1])] = d(e[2]);

            return hashParams;
        }

        const artists = [
            { name: 'Sia', id: '5WUlDfRSoLAfcVSX1WnrxN', },
            { name: 'Mariah Carey', id: '4iHNK0tOyZPYnBU7nGAgpQ', },
            { name: 'Talking Heads', id: '2x9SpqnPi8rlE9pjHBwmSC', },
            { name: 'Leonard Cohen', id: '5l8VQNuIg0turYE1VtM9zV', },
            { name: 'Mannheim Steamroller', id: '0EeHVtSdrYibpGDVHjWEpe', },
            { name: 'Sufjan Stevens', id: '4MXUO7sVCaFgFjoTI5ox5c', },
            { name: 'Neil Young', id: '6v8FB84lnmJs434UJf2Mrm', },

            { name: 'Kanye West', id: '5K4W6rqBFWDnAN6FQUkS6x'},
            { name: 'The Who', id: '67ea9eGLXYMsO2eYQRui3w',},
            { name: 'Green Day', id: '7oPftvlwr6VrsViSDV7fJY',},
            { name: 'Rage Against The Machine', id: '2d0hyoQ5ynDBnkvAbJKORj', },
            { name: 'Caroline Polachek', id: '4Ge8xMJNwt6EEXOzVXju9a', },
            { name: 'Animal Collective', id: '4kwxTgCKMipBKhSnEstNKj', },
            { name: 'Death Cab for Cutie', id: '0YrtvWJMgSdVrk3SfNjTbx', },
            { name: 'Brian Eno', id: '7MSUfLeTdDEoZiJPDSBXgi', },
            { name: 'girl in red', id: '3uwAm6vQy7kWPS2bciKWx9', },
            { name: 'Taylor Swift', id: '06HL4z0CvFAxyc27GXpf02', },
            { name: 'Taylor Swift', id: '06HL4z0CvFAxyc27GXpf02', },
            { name: 'My Bloody Valentine', id: '3G3Gdm0ZRAOxLrbyjfhii5', },
            { name: 'Better Oblivion Community Center', id: '3NBmfDV6Yh3hjuQUBVvYgO', },
            { name: '(Sandy) Alex G', id: '6lcwlkAjBPSKnFBZjjZFJs', },
            { name: 'Snail Mail', id: '4QkSD9TRUnMtI8Fq1jXJJe', },
            { name: 'New Order', id: '0yNLKJebCb8Aueb54LYya3', },
            { name: 'Four Tet', id: '7Eu1txygG6nJttLHbZdQOh', },
        ];

        const getPopularityOfSongs = async artistId => {
            const hashParams = getHashParams();
            const accessToken = hashParams.access_token;

            const response = await fetch(
                `https://api.spotify.com/v1/artists/${artistId}/top-tracks?country=US`,
                {
                    headers: {
                        'Authorization': 'Bearer ' + accessToken
                    }
                }
            );
            const responseBody = await response.json();
            // console.log(responseBody);
            return responseBody.tracks.map(track => {
                return {
                    id: track.id,
                    name: track.name,
                    popularity: track.popularity,
                };
            });
        }

        const main = async () => {
            for (artist of artists) {
                const popularityOfSongs = await getPopularityOfSongs(artist.id);
                console.log(popularityOfSongs);
                const response = await fetch('http://localhost:3000/popularity',  {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        artistName: artist.name,
                        artistId: artist.id,
                        songPopularity: popularityOfSongs,
                    }),
                });
            }
        };
        main();

        async function displayData(){
            const response = await fetch('http://localhost:3000/data', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                }
            });
            const json = await response.json()
            console.log(json)

            // obj = res.body;
            // dbParam = JSON.stringify(obj);
            // console.log(dbParam)
            // xmlhttp = new XMLHttpRequest();
            // xmlhttp.onreadystatechange = function() {
            //     if (this.readyState == 4 && this.status == 200) {
            //         myObj = JSON.parse(this.responseText);
            //         txt += "<table border='1'>"
            //         for (x in myObj) {
            //             txt += "<tr><td>" + myObj[x].name + "</td></tr>";
            //         }
            //         txt += "</table>"
            //         document.getElementById("demo").innerHTML = txt;
            //     }
            // }
            // xmlhttp.open("POST", "json_demo_db_post.php", true);
            // xmlhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            // xmlhttp.send("x=" + dbParam);
        }
    </script>

    <button onclick= "displayData()">show data</button>
</body>
</html>